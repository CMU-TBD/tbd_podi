<launch>
<arg name = "use_sim" default = "true" />

<!-- common args -->
<arg name = "robot_name" default = "podi" />
<arg name = "xacro" default="$(find tbd_podi_description)/urdf/podi.urdf.xacro"/>
<arg name = "rosbag_recording_base_path" default="$(find tbd_podi_common)/bagfiles/" />
<arg name = "launch_rviz" default="True" />
<arg name = "output" default="screen" />
<arg name = "motor_cmd_topic" default="/RosAria/cmd_vel" />
<arg name = "planner_cmd_topic" default="nav_cmd_vel" />
<arg name = "laser_topic" default="laser" />

<!-- sim args -->
<arg name="rviz_config_path" default="$(find tbd_podi_gazebo)/rviz/localization.rviz" />

<arg name="model_name" default="podi" />
<arg name="model_x" default="1" />
<arg name="model_y" default="2" />
<arg name="model_z" default="0" />
<arg name="model_yaw" default="0" />
	
<arg name="debug" value="False" />
<arg name="gui" value="True" />
<arg name="paused" value="False"/>
<arg name="use_sim_time" value="True"/>
<arg name="headless" value="False"/>
<arg name="world_name" value="$(find tbd_podi_gazebo)/worlds/tcs_perimeter.world"/>

<!-- nav args -->
<arg name = "map_name"		default = "tcs_perimeter.yaml" />
<arg name = "map_path"		default = "$(find tbd_podi_2dnav)/maps/$(arg map_name)" />
	
<arg name = "initial_pose_x"	default = "$(arg model_x)" />
<arg name = "initial_pose_y"	default = "$(arg model_y)" />
<arg name = "initial_pose_yaw"	default = "$(arg model_yaw)" />	
	
<arg name = "odom_frame_id"	default = "$(arg robot_name)_odom" />
<arg name = "base_frame_id"	default = "$(arg robot_name)_base_link" />
<arg name = "map_frame_id"	default = "$(arg robot_name)_map" />

<arg name = "odom_topic" default = "odometry/filtered" />


<!-- Load parameters -->
<group ns = "$(arg robot_name)">
	<rosparam file="$(find tbd_podi_common)/config/tuning_params_fixed.yaml" command = "load" subst_value = "True"/>
	<rosparam file="$(find tbd_podi_common)/config/tuning_params_best.yaml" command = "load" subst_value = "True"/>
	<param name="robot_description" command="$(find xacro)/xacro $(arg xacro)" />
</group>

<!-- Spawn Gazebo elements -->
<include file="$(find gazebo_ros)/launch/empty_world.launch" pass_all_args = "true"/>
<node name="$(arg robot_name)_urdf_spawner" pkg="gazebo_ros" type="spawn_model" args="-urdf -model $(arg model_name) -x $(arg model_x) -y $(arg model_y) -z $(arg model_z) -Y $(arg model_yaw) -param $(arg robot_name)/robot_description" respawn="false" output="screen" />

<!-- Launch robot nodes -->
<group ns = "$(arg robot_name)">
	<!-- robot_state (publishes transforms between links) -->
	<node name = "robot_state_publisher" pkg = "robot_state_publisher" type = "robot_state_publisher" output="$(arg output)"/>
	<node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher" />
	
	<!-- control_robot (fuses commanded velocities) --> 
	<node name = "robot_controller" pkg = "tbd_podi_common" type = "control_robot" output="$(arg output)">
		<remap from="output_cmd_vel" to="$(arg motor_cmd_topic)"/>
		<remap from="cmd_vel" to="$(arg planner_cmd_topic)"/>
		<remap from="enable_motors" to="/$(arg robot_name)/RosAria/enable_motors"/>
		<remap from="disable_motors" to="/$(arg robot_name)/RosAria/disable_motors"/>
	</node>
	
	<!-- fake UWB sensor -->
	<node name="uwb_odom" pkg="tbd_podi_gazebo" type="odom_dummy.py" args="$(arg robot_name) uwb/pose" />

	<!-- map_server (publishes map) -->
	<node name="map_server" pkg="map_server" type="map_server" args="$(arg map_path)" />

	<!-- republishes odometry with custom covariance -->
	<node name="odom_cov" pkg="tbd_podi_2dnav" type="odom_cov.py" args="odom odom/vel_cov" />

	<!-- amcl (LIDAR-based localization) -->
    <node pkg="amcl" type="amcl" name="amcl" output="screen">
        <remap from="scan" to="$(arg laser_topic)" />
    </node>
			
	<!-- robot_localization (sensor fusion for localization) -->
    <!-- (map to odom)/all -->
    <node pkg="robot_localization" type="ekf_localization_node" name="localization_odom" />
        
    <!-- (odom to base_link)/continuous -->
    <node pkg="robot_localization" type="ekf_localization_node" name="localization_base" />

	<!-- sends control-->
    <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen" required="true">
        <rosparam file="$(find tbd_podi_2dnav)/config/costmap_common_params.yaml" command="load" ns="global_costmap" />
        <rosparam file="$(find tbd_podi_2dnav)/config/costmap_common_params.yaml" command="load" ns="local_costmap" />
        <rosparam file="$(find tbd_podi_2dnav)/config/local_costmap_params.yaml" command="load" />
        <rosparam file="$(find tbd_podi_2dnav)/config/global_costmap_params.yaml" command="load" />
        <rosparam file="$(find tbd_podi_2dnav)/config/base_local_planner_params.yaml" command="load" />

        <param name="base_global_planner" value="global_planner/GlobalPlanner" />
        <param name="base_local_planner" value="dwa_local_planner/DWAPlannerROS" />

        <remap from="cmd_vel" to="$(arg planner_cmd_topic)" />
        <remap from="odom" to="$(arg odom_topic)" />
        <remap from="laser" to="$(arg laser_topic)" />
    </node>

	<!-- waypoints -->
	<node name="waypoint_sender" pkg="tbd_podi_2dnav" type="drive_waypoints.py" args="$(arg use_sim) $(arg model_name)" required="True"/>
	
</group>

<!-- rviz (visualize) -->
<node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rviz_config_path)" required="true" if="$(arg launch_rviz)"/>

</launch>