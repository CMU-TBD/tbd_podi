<launch>
	<arg name="robot_name" default="podi" />
	<arg name="launch_rviz" default="false" />
	<arg name="rviz_config_path" default="$(find tbd_podi_common)/rviz/podi_default.rviz" />
	<arg name="rosariaPort" default="/dev/ttyUSB0"/>
	<arg name="rosariaPublishLasers" default="false"/>
	<arg name="joystickDevicePath" default="/dev/input/js0"/>
	<arg name="rosbagRecordingBasePath" default="$(find tbd_podi_common)/bagfiles/"/>
	<arg name="playbackRosbagPath" default="$(find tbd_podi_common)/bagfiles/"/>
	<arg name="targetX" default="0.0"/>
	<arg name="targetY" default="0.0"/>
	<arg name="targetTh" default="0.0"/>
	<arg name="xacro" default="$(find tbd_podi_description)/urdf/podi.urdf.xacro"/>
	<arg name="joint_publish_list" default="[/podi/handle_state]"/>
	<arg name="sim" default="false"/>
	<arg name="use_joy" default="true" />
	<arg name="motor_topic_name" default="RosAria/cmd_vel" />

	<!-- Launch ROSARIA, which communicates with the P3DX Base -->
	<node pkg = "rosaria" type = "RosAria" name = "RosAria" output="screen" unless="$(arg sim)">
		<param name="port" value="$(arg rosariaPort)" type="string"/>
		<param name="publish_aria_lasers" value="$(arg rosariaPublishLasers)" type="bool"/>
	</node>

	<!-- Launch the joystick node -->
	<node pkg="joy" type="joy_node" name="joystick_node" respawn="true" if="$(arg use_joy)">
		<param name="dev" value="$(arg joystickDevicePath)" type="string"/>
	</node>

	<!-- Launch the node that will send velocity commands to actuators -->
	<node pkg="tbd_podi_common" type="control_robot" name="podi_common_control_robot" output="screen">
		<param name="rosbagRecordingBasePath" value="$(arg rosbagRecordingBasePath)" type="string"/>
		<param name="playbackRosbagPath" value="$(arg playbackRosbagPath)"/>
		<param name="targetX" value="$(arg targetX)"/>
		<param name="targetY" value="$(arg targetY)"/>
		<param name="targetTh" value="$(arg targetTh)"/>
		<param name="control_loop_rate" value="100.0"/>
		<param name="proportionalGainFactor" value="0.90"/>
		<remap from="output_cmd_vel" to="$(arg motor_topic_name)"/>
	</node>

	<group ns="$(arg robot_name)">
		<!-- Launch the node that monitors the handle height and rotation -->
		<node pkg="tbd_podi_common" type="handle_state_node.py" name="handle_state_node" output="screen" unless="$(arg sim)">
		</node>

		<!-- Launch the node that monitors computer's battery health -->
		<node pkg="tbd_podi_common" type="computer_state_node.py" name="computer_state_node" output="screen" unless="$(arg sim)" />
	</group>

	<!-- Start the P3DX's URDF broadcaster, so the appropriate TF tree is published -->
	<param name="$(arg robot_name)/robot_description" command="$(find xacro)/xacro $(arg xacro)" />
	
	<node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher">
		<rosparam param="source_list" subst_value="True">$(arg joint_publish_list)</rosparam>
		<remap from="robot_description" to="$(arg robot_name)/robot_description" />
	</node>

	<node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher">
		<param name="publish_frequency" type="double" value="30.0" />
		<remap from="robot_description" to="$(arg robot_name)/robot_description" />
		<param name="tf_prefix" value="$(arg robot_name)" />
	</node>

	<node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rviz_config_path)" required="true" if="$(arg launch_rviz)"/>

</launch>
